<!DOCTYPE html>
<html>
<head>
    <title>Ticket Details</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        /* Status badges */
        .status-badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: bold;
            color: white;
        }
        .open { background:#fbbf24; color:#1e1e1e; }
        .progress { background:#3b82f6; }
        .resolved { background:#22c55e; }

        /* Priority badges */
        .priority-badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: bold;
            color: white;
        }
        .high { background:#ef4444; }
        .medium { background:#f59e0b; }
        .low { background:#10b981; }

        .ticket-box {
            background:#1e293b;
            padding:25px;
            max-width:700px;
            margin:25px auto;
            border-radius:10px;
            box-shadow:0 0 10px rgba(0,0,0,0.4);
        }
        .label {
            font-weight:bold;
            color:#93c5fd;
            display:block;
            margin-bottom:6px;
        }
    </style>
</head>
<body>

<div class="header">Ticket Details</div>

<div class="ticket-layout">

    <!-- ================= LEFT: TICKET INFO ================= -->
    <div class="ticket-left">

        <h2 style="color:#93c5fd;">{{ ticket.ticket_code }}</h2>

        <p><b>Email:</b> {{ ticket.email }}</p>
        <p><b>Description:</b><br>{{ ticket.description }}</p>

        <p>
            <b>Status:</b>
            {% if ticket.status == "Open" %}
                <span class="status-badge open">OPEN</span>
            {% elif ticket.status == "In Progress" %}
                <span class="status-badge progress">IN PROGRESS</span>
            {% else %}
                <span class="status-badge resolved">RESOLVED</span>
            {% endif %}
        </p>

        <p>
            <b>Priority:</b>
            {% if ticket.priority == "High" %}
                <span class="priority-badge high">HIGH</span>
            {% elif ticket.priority == "Medium" %}
                <span class="priority-badge medium">MEDIUM</span>
            {% else %}
                <span class="priority-badge low">LOW</span>
            {% endif %}
        </p>

        <hr style="border-color:#334155; margin:20px 0;">

        <!-- UPDATE FORM -->
        <form method="post">

            <label class="label">Update Status</label>
            <select name="status">
                <option value="Open" {{ "selected" if ticket.status == "Open" }}>Open</option>
                <option value="In Progress" {{ "selected" if ticket.status == "In Progress" }}>In Progress</option>
                <option value="Resolved" {{ "selected" if ticket.status == "Resolved" }}>Resolved</option>
            </select>

            {% if current_user.role == "admin" %}
                <label class="label">Update Priority</label>
                <select name="priority">
                    <option value="High" {{ "selected" if ticket.priority == "High" }}>High</option>
                    <option value="Medium" {{ "selected" if ticket.priority == "Medium" }}>Medium</option>
                    <option value="Low" {{ "selected" if ticket.priority == "Low" }}>Low</option>
                </select>

                <label class="label">Assign Agent</label>
                <select name="assigned_to">
                    <option value="">Unassigned</option>
                    {% for agent in agents %}
                        <option value="{{ agent.id }}"
                            {{ "selected" if ticket.assigned_to == agent.id }}>
                            {{ agent.email }}
                        </option>
                    {% endfor %}
                </select>
            {% endif %}

            <br>
            <button class="btn-primary" type="submit">Save Changes</button>
        </form>

        <a href="/" class="back-link">‚Üê Back to Dashboard</a>
    </div>

    <!-- ================= RIGHT: NOTES ================= -->
    <div class="ticket-right">
        <h3>üìù Ticket Notes</h3>

        <div class="notes-list">
            {% if notes %}
                {% for n in notes %}
                    <div class="note-item">
                        <div class="note-header">
                            <strong>{{ n.email }}</strong>
                            <span class="note-role">{{ n.role|upper }}</span>
                            <small>{{ n.created_at }}</small>
                        </div>
                        
                        <p>{{ n.note }}</p>
                        
                        {% if images_by_note.get(n.id) %}
                            <div class="note-images">
                                {% for img in images_by_note[n.id] %}
                                    <img src="{{ url_for('static/uploads', filename=img.file_path) }}" class="note-image" loading="lazy">
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            {% else %}
                <p>No notes yet.</p>
            {% endif %}
        </div>

        <form method="POST" enctype="multipart/form-data" class="note-form">
            <textarea name="note" placeholder="Write a note..." required></textarea>
            <input type="file" name="images" multiple accept="image/*">
            <button class="btn-secondary" type="submit">Add Note</button>
        </form>
    </div>

</div>

</body>
</html>






