<!DOCTYPE html>
<html>
<head>
    <title>Ticket Details</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="icon" href="{{ url_for('static', filename='images/favicon.ico') }}">
    <style>
        /* Status badges */
        .status-badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: bold;
            color: white;
        }
        .open { background:#fbbf24; color:#1e1e1e; }
        .progress { background:#3b82f6; }
        .resolved { background:#22c55e; }

        /* Priority badges */
        .priority-badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: bold;
            color: white;
        }
        .high { background:#ef4444; }
        .medium { background:#f59e0b; }
        .low { background:#10b981; }

        .ticket-box {
            background:#1e293b;
            padding:25px;
            max-width:700px;
            margin:25px auto;
            border-radius:10px;
            box-shadow:0 0 10px rgba(0,0,0,0.4);
        }
        .label {
            font-weight:bold;
            color:#93c5fd;
            display:block;
            margin-bottom:6px;
        }
    </style>
</head>
<body>

<!-- GLOBAL LOADER -->
<div id="globalLoader" class="loader-overlay">
    <div class="loader-container">
        <img src="{{ url_for('static', filename='images/loader-logo.png') }}" class="loader-logo" style="border-radius: 20px;">
        <div class="loader-ring"></div>
    </div>
</div>

<div class="header">Ticket Details</div>

<div class="ticket-layout">

    <!-- ================= LEFT: TICKET INFO ================= -->
    <div class="ticket-left">

        <a href="/" class="back-link" onsubmit="showLoader()"><img src="{{ url_for('static', filename='images/exit.png') }}"></a>
        <h2 style="color:#93c5fd;">{{ ticket.ticket_code }}</h2>

        <p><b>Email:</b> {{ ticket.email }}</p>
        <div class="ticket-description">
            <span class="label">Description</span>
        
            <details class="email-collapse" open>
                <summary>Email Content</summary>
                <div class="email-body">
                    {{ ticket.description | safe }}
                </div>
            </details>
        </div>

        <p>
            <b>Status:</b>
            {% if ticket.status == "Open" %}
                <span class="status-badge open">OPEN</span>
            {% elif ticket.status == "In Progress" %}
                <span class="status-badge progress">IN PROGRESS</span>
            {% else %}
                <span class="status-badge resolved">RESOLVED</span>
            {% endif %}
        </p>

        <p>
            <b>Priority:</b>
            {% if ticket.priority == "High" %}
                <span class="priority-badge high">HIGH</span>
            {% elif ticket.priority == "Medium" %}
                <span class="priority-badge medium">MEDIUM</span>
            {% else %}
                <span class="priority-badge low">LOW</span>
            {% endif %}
        </p>

        <hr style="border-color:#334155; margin:20px 0;">

        <!-- UPDATE FORM -->
        <form method="post" onsubmit="showLoader()">

            <label class="label">Update Status</label>
            <select name="status">
                <option value="Open" {{ "selected" if ticket.status == "Open" }}>Open</option>
                <option value="In Progress" {{ "selected" if ticket.status == "In Progress" }}>In Progress</option>
                <option value="Resolved" {{ "selected" if ticket.status == "Resolved" }}>Resolved</option>
            </select>

            {% if current_user.role == "admin" %}
                <label class="label">Update Priority</label>
                <select name="priority">
                    <option value="High" {{ "selected" if ticket.priority == "High" }}>High</option>
                    <option value="Medium" {{ "selected" if ticket.priority == "Medium" }}>Medium</option>
                    <option value="Low" {{ "selected" if ticket.priority == "Low" }}>Low</option>
                </select>

                <label class="label">Assign Agent</label>
                <select name="assigned_to">
                    <option value="">Unassigned</option>
                    {% for agent in agents %}
                        <option value="{{ agent.id }}"
                            {{ "selected" if ticket.assigned_to == agent.id }}>
                            {{ agent.email }}
                        </option>
                    {% endfor %}
                </select>
            {% endif %}

            <br>
            <button class="btn-primary" type="submit" onsubmit="showLoader()">Save Changes</button>
        </form>

    </div>

    <!-- ================= RIGHT: NOTES ================= -->
    <div class="ticket-right">
        <h3>üìù Ticket Activity</h3>

        <div class="notes-list">
            {% for n in notes %}
                {% if n.is_system %}
                    <div class="system-note">
                        <small>{{ n.note }} ¬∑ {{ n.created_at | timeago }}</small>
                    </div>
                {% else %}
                    <div class="note-item">
                        <div class="note-header">
                            <strong>{{ n.email }}</strong>
                            <span class="note-role">{{ n.role|upper }}</span>
                            <small>{{ n.created_at | timeago }}</small>
                        </div>

                        <p>{{ n.note }}</p>

                        {% if images_by_note.get(n.id) %}
                            <div class="note-images">
                                {% for img in images_by_note[n.id] %}
                                    <img src="{{ url_for('static', filename=img.file_path) }}" class="note-image">
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                {% endif %}
            {% endfor %}
        </div>

        <form method="POST" enctype="multipart/form-data" class="note-form">
            <div class="note-input-wrapper">
                <textarea name="note" placeholder="Write a note..." required></textarea>
                <input type="file" name="images" id="noteImages" multiple accept="image/*" hidden>
                <label for="noteImages" class="attach-icon">
                    <img src="{{ url_for('static', filename='images/attachment.png') }}">
                </label>
            </div>

            <div id="imagePreviewContainer" class="image-preview-container"></div>
            <button class="btn-secondary" type="submit">Add Note</button>
        </form>
    </div>

</div>

<script>
    const loader = document.getElementById("globalLoader");

    function showLoader() {
        if (loader) loader.classList.remove("hidden");
    }

    function hideLoader() {
        if (loader) loader.classList.add("hidden");
    }

    // Hide loader when page fully loads
    window.addEventListener("load", () => {
        hideLoader();
    });

    const imageInput = document.getElementById("noteImages");
    const previewContainer = document.getElementById("imagePreviewContainer");
    
    let selectedFiles = [];
    
    imageInput.addEventListener("change", () => {
        const files = Array.from(imageInput.files);
    
        files.forEach(file => {
            if (!file.type.startsWith("image/")) return;
    
            selectedFiles.push(file);
        });
    
        updatePreview();
    });
    
    /* Render previews */
    function updatePreview() {
        previewContainer.innerHTML = "";
    
        selectedFiles.forEach((file, index) => {
            const reader = new FileReader();
    
            reader.onload = e => {
                const div = document.createElement("div");
                div.className = "image-preview";
    
                div.innerHTML = `
                    <img src="${e.target.result}">
                    <span class="remove-image" onclick="removeImage(${index})">√ó</span>
                `;
    
                previewContainer.appendChild(div);
            };
    
            reader.readAsDataURL(file);
        });
    
        syncFileInput();
    }
    
    /* Remove image */
    function removeImage(index) {
        selectedFiles.splice(index, 1);
        updatePreview();
    }
    
    /* Sync back to input so Flask receives correct files */
    function syncFileInput() {
        const dataTransfer = new DataTransfer();
    
        selectedFiles.forEach(file => dataTransfer.items.add(file));
        imageInput.files = dataTransfer.files;
    }
</script>

</body>
</html>
